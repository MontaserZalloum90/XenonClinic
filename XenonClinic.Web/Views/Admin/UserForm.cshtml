@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model XenonClinic.Web.Models.Admin.UserFormViewModel
@{
    ViewData["Title"] = Model.IsEdit ? Localizer["EditUser"] : Localizer["CreateUser"];
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">@ViewData["Title"]</h4>
    <a asp-action="Users" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>@Localizer["BackToList"]
    </a>
</div>

<div class="card card-rounded">
    <div class="card-body">
        <form asp-action="@(Model.IsEdit ? "EditUser" : "CreateUser")" method="post">
            <input type="hidden" asp-for="Id" />

            <h6 class="mb-3 border-bottom pb-2">@Localizer["BasicInformation"]</h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Email" class="form-label">@Localizer["Email"] *</label>
                    <input asp-for="Email" type="email" class="form-control" required @(Model.IsEdit ? "readonly" : "") />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="PhoneNumber" class="form-label">@Localizer["Phone"]</label>
                    <input asp-for="PhoneNumber" class="form-control" />
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <label asp-for="FirstName" class="form-label">@Localizer["FirstName"]</label>
                    <input asp-for="FirstName" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label asp-for="LastName" class="form-label">@Localizer["LastName"]</label>
                    <input asp-for="LastName" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label asp-for="DisplayName" class="form-label">@Localizer["DisplayName"]</label>
                    <input asp-for="DisplayName" class="form-control" />
                </div>
            </div>

            <h6 class="mt-4 mb-3 border-bottom pb-2">@Localizer["OrganizationAssignment"]</h6>
            <div class="row g-3">
                <div class="col-md-4">
                    <label asp-for="TenantId" class="form-label">@Localizer["Tenant"]</label>
                    <select asp-for="TenantId" class="form-select" id="tenantSelect">
                        <option value="">@Localizer["None"]</option>
                        @foreach (var tenant in Model.AvailableTenants)
                        {
                            <option value="@tenant.Id">@tenant.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label asp-for="CompanyId" class="form-label">@Localizer["Company"]</label>
                    <select asp-for="CompanyId" class="form-select" id="companySelect">
                        <option value="">@Localizer["None"]</option>
                        @foreach (var company in Model.AvailableCompanies)
                        {
                            <option value="@company.Id" data-tenant="@company.TenantId">@company.TenantName - @company.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label asp-for="PrimaryBranchId" class="form-label">@Localizer["PrimaryBranch"]</label>
                    <select asp-for="PrimaryBranchId" class="form-select" id="branchSelect">
                        <option value="">@Localizer["None"]</option>
                        @foreach (var branch in Model.AvailableBranches)
                        {
                            <option value="@branch.Id" data-company="@branch.CompanyId">@branch.CompanyName - @branch.Name</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row g-3 mt-2">
                <div class="col-12">
                    <label class="form-label">@Localizer["AdditionalBranches"]</label>
                    <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                        @foreach (var branch in Model.AvailableBranches)
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="SelectedBranchIds"
                                       value="@branch.Id" id="branch_@branch.Id"
                                       @(Model.SelectedBranchIds.Contains(branch.Id) ? "checked" : "")
                                       data-company="@branch.CompanyId">
                                <label class="form-check-label" for="branch_@branch.Id">
                                    @branch.CompanyName - @branch.Name
                                </label>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <h6 class="mt-4 mb-3 border-bottom pb-2">@Localizer["Roles"]</h6>
            <div class="row g-3">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-3">
                        @foreach (var role in Model.AvailableRoles)
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="SelectedRoles"
                                       value="@role" id="role_@role"
                                       @(Model.SelectedRoles.Contains(role) ? "checked" : "")>
                                <label class="form-check-label" for="role_@role">@role</label>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <h6 class="mt-4 mb-3 border-bottom pb-2">@Localizer["Security"]</h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Password" class="form-label">
                        @Localizer["Password"]
                        @if (!Model.IsEdit)
                        {
                            <span class="text-danger">*</span>
                        }
                        else
                        {
                            <small class="text-muted">(@Localizer["LeaveBlankToKeep"])</small>
                        }
                    </label>
                    <input asp-for="Password" type="password" class="form-control" autocomplete="new-password" />
                    <span asp-validation-for="Password" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="ConfirmPassword" class="form-label">@Localizer["ConfirmPassword"]</label>
                    <input asp-for="ConfirmPassword" type="password" class="form-control" autocomplete="new-password" />
                    <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                </div>
            </div>

            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <div class="form-check">
                        <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                        <label asp-for="IsActive" class="form-check-label">@Localizer["Active"]</label>
                    </div>
                </div>
                @if (ViewBag.IsSuperAdmin == true || Model.AvailableRoles.Contains("SuperAdmin"))
                {
                    <div class="col-md-4">
                        <div class="form-check">
                            <input asp-for="IsSuperAdmin" class="form-check-input" type="checkbox" />
                            <label asp-for="IsSuperAdmin" class="form-check-label text-danger">@Localizer["SuperAdmin"]</label>
                        </div>
                    </div>
                }
            </div>

            <div class="mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>@Localizer["Save"]
                </button>
                <a asp-action="Users" class="btn btn-outline-secondary">@Localizer["Cancel"]</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Filter companies by tenant
        document.getElementById('tenantSelect')?.addEventListener('change', function() {
            const tenantId = this.value;
            const companySelect = document.getElementById('companySelect');
            const options = companySelect.querySelectorAll('option[data-tenant]');

            options.forEach(opt => {
                opt.style.display = !tenantId || opt.dataset.tenant === tenantId ? '' : 'none';
            });

            companySelect.value = '';
            document.getElementById('branchSelect').value = '';
        });

        // Filter branches by company
        document.getElementById('companySelect')?.addEventListener('change', function() {
            const companyId = this.value;
            const branchSelect = document.getElementById('branchSelect');
            const options = branchSelect.querySelectorAll('option[data-company]');

            options.forEach(opt => {
                opt.style.display = !companyId || opt.dataset.company === companyId ? '' : 'none';
            });

            branchSelect.value = '';
        });
    </script>
}
