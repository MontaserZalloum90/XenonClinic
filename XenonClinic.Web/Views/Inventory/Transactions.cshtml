@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model List<XenonClinic.Web.Models.InventoryTransactionDto>
@{
    ViewData["Title"] = Localizer["Transactions"];
}

<div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 gap-2">
    <div>
        <h2 class="mb-0">@Localizer["InventoryTransactions"]</h2>
        @if (ViewBag.ItemName != null)
        {
            <p class="text-muted">@ViewBag.ItemName - @Model.Count @Localizer["transactions"]</p>
        }
        else
        {
            <p class="text-muted">@Model.Count @Localizer["transactions"]</p>
        }
    </div>
    <a asp-action="CreateTransaction" asp-route-itemId="@ViewBag.ItemId" class="btn btn-xenon">
        <i class="bi bi-plus-lg"></i> @Localizer["NewTransaction"]
    </a>
</div>

<!-- Filters -->
<div class="card card-rounded mb-3">
    <div class="card-body">
        <form method="get" class="row g-3">
            <input type="hidden" name="itemId" value="@ViewBag.ItemId" />
            <div class="col-md-4 col-12">
                <label class="form-label">@Localizer["FromDate"]</label>
                <input type="date" name="fromDate" value="@ViewBag.FromDate?.ToString("yyyy-MM-dd")" class="form-control" />
            </div>
            <div class="col-md-4 col-12">
                <label class="form-label">@Localizer["ToDate"]</label>
                <input type="date" name="toDate" value="@ViewBag.ToDate?.ToString("yyyy-MM-dd")" class="form-control" />
            </div>
            <div class="col-md-4 col-12 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">@Localizer["Filter"]</button>
            </div>
        </form>
    </div>
</div>

<!-- Transactions Table -->
<div class="card card-rounded">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>@Localizer["Date"]</th>
                    <th>@Localizer["ItemCode"]</th>
                    <th class="d-none d-md-table-cell">@Localizer["Item"]</th>
                    <th>@Localizer["Type"]</th>
                    <th class="text-end">@Localizer["Qty"]</th>
                    <th class="text-end d-none d-sm-table-cell">@Localizer["UnitPrice"]</th>
                    <th class="text-end d-none d-lg-table-cell">@Localizer["Total"]</th>
                    <th class="text-end">@Localizer["AfterQty"]</th>
                    <th class="d-none d-xl-table-cell">@Localizer["Reference"]</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var trans in Model)
                {
                    var rowClass = trans.Quantity > 0 ? "table-success-subtle" : "table-danger-subtle";
                    <tr class="@rowClass">
                        <td>@trans.TransactionDate.ToString("dd MMM yyyy HH:mm")</td>
                        <td>@trans.ItemCode</td>
                        <td class="d-none d-md-table-cell">@trans.InventoryItemName</td>
                        <td>
                            <span class="badge bg-secondary">@trans.TransactionTypeDisplay</span>
                        </td>
                        <td class="text-end">
                            @if (trans.Quantity > 0)
                            {
                                <span class="text-success">+@trans.Quantity</span>
                            }
                            else
                            {
                                <span class="text-danger">@trans.Quantity</span>
                            }
                        </td>
                        <td class="text-end d-none d-sm-table-cell">AED @trans.UnitPrice.ToString("N2")</td>
                        <td class="text-end d-none d-lg-table-cell">AED @trans.TotalAmount.ToString("N2")</td>
                        <td class="text-end">@trans.QuantityAfterTransaction</td>
                        <td class="d-none d-xl-table-cell">@(trans.ReferenceNumber ?? "-")</td>
                    </tr>
                    @if (!string.IsNullOrWhiteSpace(trans.Notes) || trans.PatientName != null || trans.TransferToBranchName != null)
                    {
                        <tr class="@rowClass">
                            <td colspan="9" class="py-1">
                                <small class="text-muted">
                                    @if (trans.PatientName != null)
                                    {
                                        <span>@Localizer["Patient"]: @trans.PatientName | </span>
                                    }
                                    @if (trans.TransferToBranchName != null)
                                    {
                                        <span>@Localizer["TransferTo"]: @trans.TransferToBranchName | </span>
                                    }
                                    @if (trans.PerformedBy != null)
                                    {
                                        <span>@Localizer["By"]: @trans.PerformedBy | </span>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(trans.Notes))
                                    {
                                        <span>@Localizer["Notes"]: @trans.Notes</span>
                                    }
                                </small>
                            </td>
                        </tr>
                    }
                }
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">@Localizer["NoTransactionsFound"]</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
