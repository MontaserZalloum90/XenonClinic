@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model XenonClinic.Web.Models.Admin.ModuleDetailsViewModel
@{
    ViewData["Title"] = $"{Model.DisplayName} - Module Details";
}

<div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-2">
    <h4 class="mb-0">
        @if (!string.IsNullOrEmpty(Model.IconClass))
        {
            <i class="@Model.IconClass me-2"></i>
        }
        @Model.DisplayName
    </h4>
    <a asp-action="Index" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to Modules
    </a>
</div>

<!-- Module Status Alert -->
@if (Model.IsEnabled)
{
    <div class="alert alert-success" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <strong>This module is currently enabled.</strong>
    </div>
}
else
{
    <div class="alert alert-secondary" role="alert">
        <i class="bi bi-x-circle me-2"></i>
        <strong>This module is currently disabled.</strong> To enable it, add "<code>@Model.Name</code>" to the <code>Modules:Enabled</code> array in <code>appsettings.json</code> and restart the application.
    </div>
}

<!-- License Warning -->
@if (Model.IsLicenseExpired)
{
    <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>License Expired!</strong> This module's license expired on @Model.LicenseExpiryDate.Value.ToString("MMMM dd, yyyy"). Please renew your license to continue using this module.
    </div>
}
else if (Model.DaysUntilExpiry.HasValue && Model.DaysUntilExpiry < 30)
{
    <div class="alert alert-warning" role="alert">
        <i class="bi bi-clock me-2"></i>
        <strong>License Expiring Soon!</strong> This module's license will expire in @Model.DaysUntilExpiry days (@Model.LicenseExpiryDate.Value.ToString("MMMM dd, yyyy")).
    </div>
}

<div class="row g-4">
    <!-- Module Information -->
    <div class="col-lg-8">
        <div class="card card-rounded">
            <div class="card-header">
                <h5 class="mb-0">Module Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <th style="width: 200px;">Name:</th>
                            <td><code>@Model.Name</code></td>
                        </tr>
                        <tr>
                            <th>Display Name:</th>
                            <td>@Model.DisplayName</td>
                        </tr>
                        <tr>
                            <th>Version:</th>
                            <td><span class="badge bg-secondary">v@Model.Version</span></td>
                        </tr>
                        <tr>
                            <th>Category:</th>
                            <td><span class="badge bg-info">@Model.Category</span></td>
                        </tr>
                        <tr>
                            <th>Description:</th>
                            <td>@Model.Description</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                @if (Model.IsEnabled)
                                {
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>Enabled
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-x-circle me-1"></i>Disabled
                                    </span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <th>Required:</th>
                            <td>
                                @if (Model.IsRequired)
                                {
                                    <span class="badge bg-danger">Yes - Cannot be disabled</span>
                                }
                                else
                                {
                                    <span class="text-muted">No</span>
                                }
                            </td>
                        </tr>
                        @if (Model.Dependencies != null && Model.Dependencies.Length > 0)
                        {
                            <tr>
                                <th>Dependencies:</th>
                                <td>
                                    @foreach (var dep in Model.Dependencies)
                                    {
                                        <span class="badge bg-warning text-dark me-1">@dep</span>
                                    }
                                </td>
                            </tr>
                        }
                        <tr>
                            <th>Display Order:</th>
                            <td>@Model.DisplayOrder</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- License Information -->
    <div class="col-lg-4">
        <div class="card card-rounded">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-key me-2"></i>License Information</h5>
            </div>
            <div class="card-body">
                @if (Model.IsLicenseValid)
                {
                    <div class="mb-3">
                        <label class="text-muted small">License Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-sm" value="@Model.LicenseKey" id="licenseKey" readonly>
                            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="toggleLicenseKey()">
                                <i class="bi bi-eye" id="toggleIcon"></i>
                            </button>
                        </div>
                    </div>

                    @if (Model.LicenseExpiryDate.HasValue)
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Expiry Date</label>
                            <div class="fw-semibold">
                                @Model.LicenseExpiryDate.Value.ToString("MMMM dd, yyyy")
                            </div>
                            @if (Model.IsLicenseExpired)
                            {
                                <span class="badge bg-danger mt-1">Expired</span>
                            }
                            else if (Model.DaysUntilExpiry.HasValue)
                            {
                                <div class="small text-muted mt-1">
                                    @Model.DaysUntilExpiry days remaining
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Expiry Date</label>
                            <div class="fw-semibold">
                                <span class="badge bg-success">Perpetual</span>
                            </div>
                        </div>
                    }

                    @if (Model.MaxUsers.HasValue && Model.MaxUsers > 0)
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Maximum Users</label>
                            <div class="fw-semibold">
                                <i class="bi bi-people me-1"></i>@Model.MaxUsers users
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Maximum Users</label>
                            <div class="fw-semibold">
                                <span class="badge bg-success">Unlimited</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-warning mb-0" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>No License Configured</strong>
                        <p class="small mb-0 mt-2">To add a license, update the <code>Modules:Licenses:@Model.Name</code> section in <code>appsettings.json</code>.</p>
                    </div>
                }
            </div>
        </div>

        <!-- Configuration Guide -->
        <div class="card card-rounded mt-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Configuration</h6>
            </div>
            <div class="card-body">
                <h6 class="small">To Enable This Module:</h6>
                <pre class="bg-light p-2 rounded small"><code>"Modules": {
  "Enabled": [
    "@Model.Name"
  ]
}</code></pre>

                <h6 class="small mt-3">To Configure License:</h6>
                <pre class="bg-light p-2 rounded small"><code>"Modules": {
  "Licenses": {
    "@Model.Name": {
      "LicenseKey": "YOUR-LICENSE-KEY",
      "ExpiryDate": "2025-12-31",
      "MaxUsers": 100
    }
  }
}</code></pre>
                <div class="alert alert-info small mb-0 mt-2">
                    <i class="bi bi-info-circle me-1"></i>
                    Changes require application restart.
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function toggleLicenseKey() {
        const input = document.getElementById('licenseKey');
        const icon = document.getElementById('toggleIcon');

        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }
</script>
}
