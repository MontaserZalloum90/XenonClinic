@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["AppointmentCalendar"];
}

<div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 gap-2">
    <div>
        <h2 class="mb-0">@Localizer["AppointmentCalendar"]</h2>
        <p class="text-muted mb-0">@Localizer["VisualSchedulingView"]</p>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" asp-action="Index">
            <i class="bi bi-list-ul"></i> @Localizer["ListView"]
        </a>
        <a class="btn btn-xenon" asp-action="Create">
            <i class="bi bi-plus-lg"></i> @Localizer["NewAppointment"]
        </a>
    </div>
</div>

<!-- Calendar Controls -->
<div class="card card-rounded mb-3 p-3">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label for="providerFilter" class="form-label">@Localizer["FilterByProvider"]</label>
            <select id="providerFilter" class="form-select">
                <option value="">@Localizer["AllProviders"]</option>
            </select>
        </div>
        <div class="col-md-8">
            <div class="d-flex justify-content-end gap-2">
                <button id="prevBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button id="todayBtn" class="btn btn-outline-primary">
                    @Localizer["Today"]
                </button>
                <button id="nextBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Container -->
<div class="card card-rounded p-3">
    <div id="calendar"></div>
</div>

<!-- Legend -->
<div class="card card-rounded mt-3 p-3">
    <h6 class="mb-3">@Localizer["Legend"]</h6>
    <div class="d-flex flex-wrap gap-3">
        <div class="d-flex align-items-center">
            <div style="width: 20px; height: 20px; background-color: #0d6efd; border-radius: 3px;" class="me-2"></div>
            <span>@Localizer["Booked"]</span>
        </div>
        <div class="d-flex align-items-center">
            <div style="width: 20px; height: 20px; background-color: #198754; border-radius: 3px;" class="me-2"></div>
            <span>@Localizer["Completed"]</span>
        </div>
        <div class="d-flex align-items-center">
            <div style="width: 20px; height: 20px; background-color: #dc3545; border-radius: 3px;" class="me-2"></div>
            <span>@Localizer["Cancelled"]</span>
        </div>
        <div class="d-flex align-items-center">
            <div style="width: 20px; height: 20px; background-color: #ffc107; border-radius: 3px;" class="me-2"></div>
            <span>@Localizer["NoShow"]</span>
        </div>
    </div>
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var providerFilter = document.getElementById('providerFilter');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'dayGridMonth,timeGridWeek,timeGridDay',
                    center: 'title',
                    right: ''
                },
                height: 'auto',
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                nowIndicator: true,
                navLinks: true,
                editable: false,
                selectable: true,
                selectMirror: true,
                dayMaxEvents: true,
                weekends: true,
                firstDay: 0, // Sunday

                events: function(info, successCallback, failureCallback) {
                    var providerId = providerFilter.value;
                    var url = '@Url.Action("GetAppointmentsJson", "Appointments")';

                    fetch(url + '?start=' + info.startStr + '&end=' + info.endStr + (providerId ? '&providerId=' + providerId : ''))
                        .then(response => response.json())
                        .then(data => {
                            successCallback(data);
                        })
                        .catch(error => {
                            console.error('Error loading appointments:', error);
                            failureCallback(error);
                        });
                },

                eventClick: function(info) {
                    // Redirect to appointment details
                    window.location.href = '@Url.Action("Details", "Appointments")/' + info.event.id;
                },

                select: function(info) {
                    // Redirect to create appointment with pre-filled date and time
                    var start = new Date(info.start);
                    var url = '@Url.Action("Create", "Appointments")';
                    window.location.href = url;
                },

                eventContent: function(arg) {
                    let html = '<div class="fc-event-main-frame p-1">';
                    html += '<div class="fc-event-time fw-bold">' + arg.timeText + '</div>';
                    html += '<div class="fc-event-title">' + arg.event.title + '</div>';
                    if (arg.event.extendedProps.providerName) {
                        html += '<div class="fc-event-provider small text-white-50">' + arg.event.extendedProps.providerName + '</div>';
                    }
                    html += '</div>';
                    return { html: html };
                }
            });

            calendar.render();

            // Load providers for filter dropdown
            fetch('@Url.Action("GetAppointmentsJson", "Appointments")?start=2000-01-01&end=2000-01-02')
                .then(() => {
                    // Load providers dropdown
                    return fetch('/api/providers'); // This would need to be implemented
                })
                .catch(() => {
                    // If API not available, hide provider filter
                    providerFilter.closest('.col-md-4').style.display = 'none';
                });

            // Provider filter change
            providerFilter.addEventListener('change', function() {
                calendar.refetchEvents();
            });

            // Navigation buttons
            document.getElementById('prevBtn').addEventListener('click', function() {
                calendar.prev();
            });

            document.getElementById('todayBtn').addEventListener('click', function() {
                calendar.today();
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                calendar.next();
            });
        });
    </script>

    <style>
        #calendar {
            max-width: 100%;
        }

        .fc-event {
            cursor: pointer;
            border: none !important;
        }

        .fc-event-main {
            color: white;
        }

        .fc-event:hover {
            opacity: 0.85;
        }

        .fc-daygrid-event {
            white-space: normal !important;
        }

        .fc-toolbar-title {
            font-size: 1.5rem !important;
        }

        @media (max-width: 768px) {
            .fc-toolbar-title {
                font-size: 1.2rem !important;
            }

            .fc-header-toolbar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
}
