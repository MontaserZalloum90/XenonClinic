@model XenonClinic.Core.Entities.Sale
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResources> Localizer

@{
    ViewData["Title"] = $"{Localizer["Invoice"]} - {Model.InvoiceNumber}";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@Localizer["Invoice"] - @Model.InvoiceNumber</h2>
        <div>
            <a asp-action="Invoices" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> @Localizer["Back_to_List"]
            </a>
            <button onclick="window.print()" class="btn btn-outline-primary">
                <i class="bi bi-printer"></i> @Localizer["Print"]
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Invoice Details -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">@Localizer["Invoice_Details"]</h5>
                </div>
                <div class="card-body">
                    <!-- Header Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>@Localizer["Customer_Information"]</h6>
                            <p class="mb-1"><strong>@Model.Patient.FullNameEn</strong></p>
                            @if (!string.IsNullOrEmpty(Model.Patient.EmiratesId))
                            {
                                <p class="mb-1 small text-muted">@Localizer["Emirates_ID"]: @Model.Patient.EmiratesId</p>
                            }
                            @if (!string.IsNullOrEmpty(Model.Patient.Phone))
                            {
                                <p class="mb-1 small"><i class="bi bi-telephone"></i> @Model.Patient.Phone</p>
                            }
                        </div>
                        <div class="col-md-6 text-end">
                            <p class="mb-1"><strong>@Localizer["Invoice_Date"]:</strong> @Model.SaleDate.ToString("yyyy-MM-dd")</p>
                            @if (Model.DueDate.HasValue)
                            {
                                <p class="mb-1"><strong>@Localizer["Due_Date"]:</strong> @Model.DueDate.Value.ToString("yyyy-MM-dd")</p>
                            }
                            <p class="mb-1">
                                <strong>@Localizer["Status"]:</strong>
                                @{
                                    var statusClass = Model.Status switch
                                    {
                                        XenonClinic.Core.Enums.SaleStatus.Draft => "secondary",
                                        XenonClinic.Core.Enums.SaleStatus.Confirmed => "info",
                                        XenonClinic.Core.Enums.SaleStatus.Completed => "success",
                                        XenonClinic.Core.Enums.SaleStatus.Cancelled => "dark",
                                        XenonClinic.Core.Enums.SaleStatus.Refunded => "warning",
                                        _ => "secondary"
                                    };
                                }
                                <span class="badge bg-@statusClass">@Localizer[$"SaleStatus_{Model.Status}"]</span>
                            </p>
                            <p class="mb-1">
                                <strong>@Localizer["Payment"]:</strong>
                                @{
                                    var paymentClass = Model.PaymentStatus switch
                                    {
                                        XenonClinic.Core.Enums.PaymentStatus.Paid => "success",
                                        XenonClinic.Core.Enums.PaymentStatus.Partial => "warning",
                                        XenonClinic.Core.Enums.PaymentStatus.Pending => "secondary",
                                        XenonClinic.Core.Enums.PaymentStatus.Overdue => "danger",
                                        _ => "secondary"
                                    };
                                }
                                <span class="badge bg-@paymentClass">@Localizer[$"PaymentStatus_{Model.PaymentStatus}"]</span>
                            </p>
                        </div>
                    </div>

                    <!-- Items Table -->
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>@Localizer["Item"]</th>
                                    <th class="text-center">@Localizer["Qty"]</th>
                                    <th class="text-end">@Localizer["Unit_Price"]</th>
                                    <th class="text-end">@Localizer["Discount"]</th>
                                    <th class="text-end">@Localizer["Tax"]</th>
                                    <th class="text-end">@Localizer["Total"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Items)
                                {
                                    <tr>
                                        <td>
                                            <strong>@item.ItemName</strong>
                                            @if (!string.IsNullOrEmpty(item.ItemDescription))
                                            {
                                                <div class="small text-muted">@item.ItemDescription</div>
                                            }
                                            @if (!string.IsNullOrEmpty(item.SerialNumber))
                                            {
                                                <div class="small"><strong>@Localizer["Serial"]:</strong> @item.SerialNumber</div>
                                            }
                                        </td>
                                        <td class="text-center">@item.Quantity</td>
                                        <td class="text-end">@item.UnitPrice.ToString("N2")</td>
                                        <td class="text-end">@((item.DiscountAmount ?? 0).ToString("N2"))</td>
                                        <td class="text-end">@((item.TaxAmount ?? 0).ToString("N2"))</td>
                                        <td class="text-end"><strong>@item.Total.ToString("N2")</strong></td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" class="text-end"><strong>@Localizer["Subtotal"]:</strong></td>
                                    <td class="text-end"><strong>@Model.SubTotal.ToString("N2") AED</strong></td>
                                </tr>
                                @if (Model.DiscountAmount.HasValue && Model.DiscountAmount.Value > 0)
                                {
                                    <tr>
                                        <td colspan="5" class="text-end">@Localizer["Discount"]:</td>
                                        <td class="text-end text-danger">-@Model.DiscountAmount.Value.ToString("N2") AED</td>
                                    </tr>
                                }
                                @if (Model.TaxAmount.HasValue && Model.TaxAmount.Value > 0)
                                {
                                    <tr>
                                        <td colspan="5" class="text-end">@Localizer["Tax"] (@(Model.TaxPercentage ?? 0)%):</td>
                                        <td class="text-end">@Model.TaxAmount.Value.ToString("N2") AED</td>
                                    </tr>
                                }
                                <tr class="table-primary">
                                    <td colspan="5" class="text-end"><strong>@Localizer["Total_Amount"]:</strong></td>
                                    <td class="text-end"><h5 class="mb-0">@Model.Total.ToString("N2") AED</h5></td>
                                </tr>
                                <tr class="table-success">
                                    <td colspan="5" class="text-end"><strong>@Localizer["Paid_Amount"]:</strong></td>
                                    <td class="text-end"><strong>@Model.PaidAmount.ToString("N2") AED</strong></td>
                                </tr>
                                <tr class="@(Model.Balance > 0 ? "table-warning" : "")">
                                    <td colspan="5" class="text-end"><strong>@Localizer["Balance_Due"]:</strong></td>
                                    <td class="text-end"><h5 class="mb-0 @(Model.Balance > 0 ? "text-danger" : "text-success")">@Model.Balance.ToString("N2") AED</h5></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Notes -->
                    @if (!string.IsNullOrEmpty(Model.Notes))
                    {
                        <div class="alert alert-info">
                            <strong>@Localizer["Notes"]:</strong>
                            <p class="mb-0">@Model.Notes</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Payment Section -->
        <div class="col-lg-4 mb-4">
            <!-- Record Payment Card -->
            @if (Model.Balance > 0 && Model.Status != XenonClinic.Core.Enums.SaleStatus.Cancelled)
            {
                <div class="card mb-4 border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">@Localizer["Record_Payment"]</h5>
                    </div>
                    <div class="card-body">
                        <form asp-action="RecordPayment" method="post">
                            <input type="hidden" name="SaleId" value="@Model.Id" />

                            <div class="mb-3">
                                <label class="form-label">@Localizer["Amount"] (AED) <span class="text-danger">*</span></label>
                                <input type="number" name="Amount" class="form-control" step="0.01" max="@Model.Balance" value="@Model.Balance" required />
                                <small class="form-text text-muted">@Localizer["Maximum"]: @Model.Balance.ToString("N2") AED</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">@Localizer["Payment_Method"] <span class="text-danger">*</span></label>
                                <select name="PaymentMethod" class="form-select" required>
                                    @foreach (var method in Enum.GetValues<XenonClinic.Core.Enums.PaymentMethod>())
                                    {
                                        <option value="@method">@Localizer[$"PaymentMethod_{method}"]</option>
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">@Localizer["Payment_Date"]</label>
                                <input type="date" name="PaymentDate" class="form-control" value="@DateTime.UtcNow.ToString("yyyy-MM-dd")" required />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">@Localizer["Reference_Number"]</label>
                                <input type="text" name="ReferenceNumber" class="form-control" placeholder="@Localizer["Transaction_ID_Check_Number"]" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">@Localizer["Notes"]</label>
                                <textarea name="Notes" class="form-control" rows="2"></textarea>
                            </div>

                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-cash-coin"></i> @Localizer["Record_Payment"]
                            </button>
                        </form>
                    </div>
                </div>
            }

            <!-- Payment History -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">@Localizer["Payment_History"]</h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.Payments.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var payment in Model.Payments.OrderByDescending(p => p.PaymentDate))
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>@payment.PaymentNumber</strong>
                                            <div class="small text-muted">
                                                @payment.PaymentDate.ToString("yyyy-MM-dd HH:mm")
                                            </div>
                                            <div class="mt-1">
                                                <span class="badge bg-info">@Localizer[$"PaymentMethod_{payment.PaymentMethod}"]</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(payment.ReferenceNumber))
                                            {
                                                <div class="small mt-1">@Localizer["Ref"]: @payment.ReferenceNumber</div>
                                            }
                                        </div>
                                        <div class="text-end">
                                            <strong class="text-success">@payment.Amount.ToString("N2") AED</strong>
                                            <div class="small text-muted">@payment.ReceivedBy</div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-cash-stack fs-1 d-block mb-2"></i>
                            @Localizer["No_Payments_Yet"]
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        @@media print {
            .btn, .card-header, nav, footer { display: none !important; }
        }
    </style>
}
