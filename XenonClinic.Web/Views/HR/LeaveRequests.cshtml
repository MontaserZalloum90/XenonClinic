@model IEnumerable<XenonClinic.Web.Models.LeaveRequestDto>
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResources> Localizer

@{
    ViewData["Title"] = Localizer["Leave_Requests"];
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@Localizer["Leave_Requests"]</h2>
        <a asp-action="CreateLeaveRequest" class="btn btn-success">
            <i class="bi bi-calendar-plus"></i> @Localizer["New_Leave_Request"]
        </a>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">@Localizer["Status"]</label>
                    <select name="status" class="form-select">
                        <option value="">@Localizer["All_Statuses"]</option>
                        @foreach (var status in Enum.GetValues<XenonClinic.Core.Enums.LeaveStatus>())
                        {
                            <option value="@status" selected="@(Context.Request.Query["status"] == status.ToString() ? "selected" : null)">
                                @Localizer[$"LeaveStatus_{status}"]
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">@Localizer["Leave_Type"]</label>
                    <select name="leaveType" class="form-select">
                        <option value="">@Localizer["All_Types"]</option>
                        @foreach (var type in Enum.GetValues<XenonClinic.Core.Enums.LeaveType>())
                        {
                            <option value="@type" selected="@(Context.Request.Query["leaveType"] == type.ToString() ? "selected" : null)">
                                @Localizer[$"LeaveType_{type}"]
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">@Localizer["From_Date"]</label>
                    <input type="date" name="fromDate" class="form-control" value="@Context.Request.Query["fromDate"]">
                </div>
                <div class="col-md-2">
                    <label class="form-label">@Localizer["To_Date"]</label>
                    <input type="date" name="toDate" class="form-control" value="@Context.Request.Query["toDate"]">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="bi bi-search"></i> @Localizer["Search"]
                    </button>
                    <a asp-action="LeaveRequests" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> @Localizer["Clear"]
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Leave Requests Table -->
    <div class="card">
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>@Localizer["Employee"]</th>
                                <th>@Localizer["Leave_Type"]</th>
                                <th>@Localizer["Start_Date"]</th>
                                <th>@Localizer["End_Date"]</th>
                                <th>@Localizer["Total_Days"]</th>
                                <th>@Localizer["Status"]</th>
                                <th>@Localizer["Reason"]</th>
                                <th>@Localizer["Actions"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var leave in Model)
                            {
                                <tr class="@(leave.IsActive ? "table-warning" : "")">
                                    <td>
                                        <strong>@leave.EmployeeName</strong>
                                        <small class="d-block text-muted">@leave.EmployeeCode</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@Localizer[$"LeaveType_{leave.LeaveType}"]</span>
                                    </td>
                                    <td>@leave.StartDate.ToString("yyyy-MM-dd")</td>
                                    <td>@leave.EndDate.ToString("yyyy-MM-dd")</td>
                                    <td>
                                        <strong>@leave.TotalDays</strong> @Localizer["Days"]
                                        @if (leave.IsActive)
                                        {
                                            <span class="badge bg-info ms-1">@Localizer["Active"]</span>
                                        }
                                    </td>
                                    <td>
                                        @{
                                            var statusClass = leave.Status switch
                                            {
                                                XenonClinic.Core.Enums.LeaveStatus.Pending => "warning",
                                                XenonClinic.Core.Enums.LeaveStatus.Approved => "success",
                                                XenonClinic.Core.Enums.LeaveStatus.Rejected => "danger",
                                                XenonClinic.Core.Enums.LeaveStatus.Cancelled => "secondary",
                                                _ => "secondary"
                                            };
                                        }
                                        <span class="badge bg-@statusClass">@Localizer[$"LeaveStatus_{leave.Status}"]</span>
                                    </td>
                                    <td>
                                        <small>@(leave.Reason?.Length > 50 ? leave.Reason.Substring(0, 50) + "..." : leave.Reason)</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewModal@(leave.Id)" title="@Localizer["View"]">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            @if (leave.Status == XenonClinic.Core.Enums.LeaveStatus.Pending)
                                            {
                                                <form asp-action="ApproveLeave" method="post" class="d-inline">
                                                    <input type="hidden" name="id" value="@leave.Id" />
                                                    <button type="submit" class="btn btn-outline-success" title="@Localizer["Approve"]">
                                                        <i class="bi bi-check-circle"></i>
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#rejectModal@(leave.Id)" title="@Localizer["Reject"]">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>

                                <!-- View Details Modal -->
                                <div class="modal fade" id="viewModal@(leave.Id)" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">@Localizer["Leave_Request_Details"]</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <strong>@Localizer["Employee"]:</strong>
                                                    <p>@leave.EmployeeName (@leave.EmployeeCode)</p>
                                                </div>
                                                <div class="mb-3">
                                                    <strong>@Localizer["Leave_Type"]:</strong>
                                                    <p><span class="badge bg-secondary">@Localizer[$"LeaveType_{leave.LeaveType}"]</span></p>
                                                </div>
                                                <div class="mb-3">
                                                    <strong>@Localizer["Duration"]:</strong>
                                                    <p>@leave.StartDate.ToString("yyyy-MM-dd") to @leave.EndDate.ToString("yyyy-MM-dd") (@leave.TotalDays @Localizer["Days"])</p>
                                                </div>
                                                <div class="mb-3">
                                                    <strong>@Localizer["Status"]:</strong>
                                                    <p><span class="badge bg-@statusClass">@Localizer[$"LeaveStatus_{leave.Status}"]</span></p>
                                                </div>
                                                <div class="mb-3">
                                                    <strong>@Localizer["Reason"]:</strong>
                                                    <p>@leave.Reason</p>
                                                </div>
                                                @if (leave.Status == XenonClinic.Core.Enums.LeaveStatus.Approved || leave.Status == XenonClinic.Core.Enums.LeaveStatus.Rejected)
                                                {
                                                    <div class="mb-3">
                                                        <strong>@Localizer["Approved_By"]:</strong>
                                                        <p>@(leave.ApprovedByName ?? "-")</p>
                                                    </div>
                                                    <div class="mb-3">
                                                        <strong>@Localizer["Approval_Date"]:</strong>
                                                        <p>@(leave.ApprovedDate?.ToString("yyyy-MM-dd HH:mm") ?? "-")</p>
                                                    </div>
                                                }
                                                @if (leave.Status == XenonClinic.Core.Enums.LeaveStatus.Rejected && !string.IsNullOrEmpty(leave.RejectionReason))
                                                {
                                                    <div class="alert alert-danger mb-0">
                                                        <strong>@Localizer["Rejection_Reason"]:</strong>
                                                        <p class="mb-0">@leave.RejectionReason</p>
                                                    </div>
                                                }
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Close"]</button>
                                                @if (leave.Status == XenonClinic.Core.Enums.LeaveStatus.Pending)
                                                {
                                                    <form asp-action="ApproveLeave" method="post" class="d-inline">
                                                        <input type="hidden" name="id" value="@leave.Id" />
                                                        <button type="submit" class="btn btn-success">@Localizer["Approve"]</button>
                                                    </form>
                                                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#rejectModal@(leave.Id)">
                                                        @Localizer["Reject"]
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Reject Modal -->
                                @if (leave.Status == XenonClinic.Core.Enums.LeaveStatus.Pending)
                                {
                                    <div class="modal fade" id="rejectModal@(leave.Id)" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <form asp-action="RejectLeave" method="post">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">@Localizer["Reject_Leave_Request"]</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <input type="hidden" name="id" value="@leave.Id" />
                                                        <div class="mb-3">
                                                            <p><strong>@Localizer["Employee"]:</strong> @leave.EmployeeName</p>
                                                            <p><strong>@Localizer["Duration"]:</strong> @leave.StartDate.ToString("yyyy-MM-dd") - @leave.EndDate.ToString("yyyy-MM-dd")</p>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">@Localizer["Rejection_Reason"] <span class="text-danger">*</span></label>
                                                            <textarea name="reason" class="form-control" rows="3" required></textarea>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                                                        <button type="submit" class="btn btn-danger">@Localizer["Reject"]</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card-footer">
                    <div class="text-muted">
                        @Localizer["Total"]: @Model.Count() @Localizer["Leave_Requests"]
                    </div>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 d-block mb-3 text-muted"></i>
                    <h5 class="text-muted">@Localizer["No_Leave_Requests_Found"]</h5>
                    <p class="text-muted">@Localizer["Try_Different_Filters"]</p>
                    <a asp-action="CreateLeaveRequest" class="btn btn-success mt-3">
                        <i class="bi bi-calendar-plus"></i> @Localizer["Create_First_Leave_Request"]
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Highlight active leaves
        document.addEventListener('DOMContentLoaded', function() {
            const activeRows = document.querySelectorAll('.table-warning');
            activeRows.forEach(row => {
                row.setAttribute('title', '@Localizer["Currently_On_Leave"]');
            });
        });
    </script>
}
