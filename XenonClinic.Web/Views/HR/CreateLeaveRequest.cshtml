@model XenonClinic.Web.Models.CreateLeaveRequestViewModel
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResources> Localizer

@{
    ViewData["Title"] = Localizer["New_Leave_Request"];
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@Localizer["New_Leave_Request"]</h2>
        <a asp-action="LeaveRequests" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> @Localizer["Back_to_List"]
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-body">
                    <form asp-action="CreateLeaveRequest" method="post">
                        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                        <div class="mb-4">
                            <label asp-for="EmployeeId" class="form-label">@Localizer["Employee"] <span class="text-danger">*</span></label>
                            <select asp-for="EmployeeId" class="form-select" asp-items="ViewBag.Employees" id="employeeSelect">
                                <option value="">@Localizer["Select_Employee"]</option>
                            </select>
                            <span asp-validation-for="EmployeeId" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="LeaveType" class="form-label">@Localizer["Leave_Type"] <span class="text-danger">*</span></label>
                            <select asp-for="LeaveType" class="form-select">
                                @foreach (var type in Enum.GetValues<XenonClinic.Core.Enums.LeaveType>())
                                {
                                    <option value="@type">@Localizer[$"LeaveType_{type}"]</option>
                                }
                            </select>
                            <span asp-validation-for="LeaveType" class="text-danger"></span>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="StartDate" class="form-label">@Localizer["Start_Date"] <span class="text-danger">*</span></label>
                                <input asp-for="StartDate" type="date" class="form-control" id="startDate" />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EndDate" class="form-label">@Localizer["End_Date"] <span class="text-danger">*</span></label>
                                <input asp-for="EndDate" type="date" class="form-control" id="endDate" />
                                <span asp-validation-for="EndDate" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="alert alert-info mb-4" id="daysInfo" style="display: none;">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>@Localizer["Total_Days"]:</strong> <span id="totalDays">0</span> @Localizer["Days"]
                        </div>

                        <div class="mb-4">
                            <label asp-for="Reason" class="form-label">@Localizer["Reason"] <span class="text-danger">*</span></label>
                            <textarea asp-for="Reason" class="form-control" rows="4" placeholder="@Localizer["Leave_Reason_Placeholder"]"></textarea>
                            <span asp-validation-for="Reason" class="text-danger"></span>
                            <small class="form-text text-muted">@Localizer["Leave_Reason_Help"]</small>
                        </div>

                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>@Localizer["Note"]:</strong> @Localizer["Leave_Request_Note"]
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a asp-action="LeaveRequests" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> @Localizer["Cancel"]
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> @Localizer["Submit"]
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Leave Type Descriptions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">@Localizer["Leave_Types_Guide"]</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6><span class="badge bg-primary">@Localizer["LeaveType_Annual"]</span></h6>
                            <p class="small text-muted">@Localizer["LeaveType_Annual_Description"]</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><span class="badge bg-danger">@Localizer["LeaveType_Sick"]</span></h6>
                            <p class="small text-muted">@Localizer["LeaveType_Sick_Description"]</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><span class="badge bg-warning text-dark">@Localizer["LeaveType_Emergency"]</span></h6>
                            <p class="small text-muted">@Localizer["LeaveType_Emergency_Description"]</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><span class="badge bg-info">@Localizer["LeaveType_Maternity"]</span></h6>
                            <p class="small text-muted">@Localizer["LeaveType_Maternity_Description"]</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><span class="badge bg-info">@Localizer["LeaveType_Paternity"]</span></h6>
                            <p class="small text-muted">@Localizer["LeaveType_Paternity_Description"]</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><span class="badge bg-secondary">@Localizer["LeaveType_Unpaid"]</span></h6>
                            <p class="small text-muted">@Localizer["LeaveType_Unpaid_Description"]</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><span class="badge bg-success">@Localizer["LeaveType_Study"]</span></h6>
                            <p class="small text-muted">@Localizer["LeaveType_Study_Description"]</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><span class="badge bg-dark">@Localizer["LeaveType_Hajj"]</span></h6>
                            <p class="small text-muted">@Localizer["LeaveType_Hajj_Description"]</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').min = today;
        document.getElementById('endDate').min = today;

        // Calculate total days
        function calculateDays() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = end - start;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end days

                if (diffDays > 0) {
                    document.getElementById('totalDays').textContent = diffDays;
                    document.getElementById('daysInfo').style.display = 'block';
                } else {
                    document.getElementById('daysInfo').style.display = 'none';
                }

                // Update end date minimum to be at least start date
                document.getElementById('endDate').min = startDate;
            } else {
                document.getElementById('daysInfo').style.display = 'none';
            }
        }

        document.getElementById('startDate').addEventListener('change', calculateDays);
        document.getElementById('endDate').addEventListener('change', calculateDays);

        // Auto-select employee if only one employee in the list
        const employeeSelect = document.getElementById('employeeSelect');
        if (employeeSelect.options.length === 2) { // Only "Select Employee" and one employee
            employeeSelect.selectedIndex = 1;
        }

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);

                if (end < start) {
                    e.preventDefault();
                    alert('@Localizer["End_Date_Must_Be_After_Start"]');
                    return false;
                }
            }
        });

        // Leave type descriptions tooltip
        const leaveTypeSelect = document.querySelector('select[name="LeaveType"]');
        leaveTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            // Could add dynamic tooltip or description based on selected type
        });
    </script>
}
