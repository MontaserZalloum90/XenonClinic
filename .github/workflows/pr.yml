name: PR Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  # Check PR title follows conventional commits
  pr-title:
    name: PR Title Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false

  # Run all CI checks
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  # Check for breaking changes
  breaking-changes:
    name: Breaking Changes Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for API breaking changes
        run: |
          # Check if any controller files were modified
          MODIFIED_CONTROLLERS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E 'Controllers/.*\.cs$' || true)

          if [ -n "$MODIFIED_CONTROLLERS" ]; then
            echo "::warning::API controllers were modified. Please ensure backward compatibility."
            echo "Modified controllers:"
            echo "$MODIFIED_CONTROLLERS"
          fi

      - name: Check for database migration
        run: |
          # Check if any migration files were added
          NEW_MIGRATIONS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E 'Migrations/.*\.cs$' || true)

          if [ -n "$NEW_MIGRATIONS" ]; then
            echo "::warning::New database migrations detected. Please ensure they are reversible."
            echo "New migrations:"
            echo "$NEW_MIGRATIONS"
          fi

  # Size check
  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          ADDITIONS=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4}')
          DELETIONS=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $6}')

          ADDITIONS=${ADDITIONS:-0}
          DELETIONS=${DELETIONS:-0}

          TOTAL=$((ADDITIONS + DELETIONS))

          echo "Lines changed: +$ADDITIONS -$DELETIONS (total: $TOTAL)"

          if [ "$TOTAL" -gt 1000 ]; then
            echo "::warning::Large PR detected ($TOTAL lines). Consider breaking it into smaller PRs."
          fi

          if [ "$TOTAL" -gt 2000 ]; then
            echo "::error::Very large PR ($TOTAL lines). Please break it into smaller PRs for easier review."
            exit 1
          fi

  # Summary comment
  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [ci, breaking-changes, size-check]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## PR Check Summary')
            );

            const ciStatus = '${{ needs.ci.result }}' === 'success' ? '✅' : '❌';
            const breakingStatus = '${{ needs.breaking-changes.result }}' === 'success' ? '✅' : '⚠️';
            const sizeStatus = '${{ needs.size-check.result }}' === 'success' ? '✅' : '⚠️';

            const body = `## PR Check Summary

            | Check | Status |
            |-------|--------|
            | CI Checks | ${ciStatus} |
            | Breaking Changes | ${breakingStatus} |
            | PR Size | ${sizeStatus} |

            ---
            *Automated check by GitHub Actions*
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
